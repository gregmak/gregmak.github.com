<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Gregmak.github.com : Quelques tutoriels" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Gregmak.github.com</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/gregmak">View on GitHub</a>

          <h1 id="project_title">Gregmak.github.com</h1>
          <h2 id="project_tagline">Quelques tutoriels</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>Travaillant chez <strong>MLstate</strong>, la compagnie ayant développé le framework JavaScript <strong>Opa</strong> basé sur <strong>Node.js</strong>, j'ai trouvé intéressant de présenter quelques tutoriels et comparatifs avec d'autres frameworks JS.</p>

<p>Le but de ces tutoriels est de montrer comment <strong>Opa</strong> se compare à d'autres frameworks (tels que <strong>Express.js</strong> ou <strong>Backbone.js</strong>) et quels sont ses avantages que les autres n'ont pas forcément (tels que le typage statique ou encore le <em>slicing</em> : découpe automatique du code entre <strong>code client</strong> et <strong>code serveur</strong>).</p>

<h2>Création d'un web-service <strong>RESTful</strong>.</h2>

<p>Le premier de ces tutoriels portera sur la gestion en <strong>Opa</strong> des requêtes HTTP de type <strong>REST</strong> et permettra de comparer <strong>Opa</strong> avec <strong>Express.js</strong>, framework facilitant le développement de services <strong>RESTful</strong> en JavaScript.</p>

<p>Pour ce faire, nous allons écrire une petite application permettant de traiter des requêtes <strong>REST</strong> telles que <strong>POST</strong>, <strong>PUT</strong>, <strong>DELETE</strong> et <strong>GET</strong> et de manipuler des ressources en conséquence.
Cette application est inspirée de celle développée par <strong>k33g_org</strong> et dont vous pouvez voir le tutoriel à l'adresse <a href="http://k33g.github.com/2012/02/19/EXPRESSJS_IS_PLAY.html">http://k33g.github.com/2012/02/19/EXPRESSJS_IS_PLAY.html</a>.</p>

<h4>Pre-requis.</h4>

<p>Vous devez bien sûr installer <strong>Opa</strong>, téléchargeable directement depuis le site d'<a href="http://opalang.org">opalang</a>, ou depuis le <a href="https://github.com/MLstate/opalang">repo github d'opalang</a>.</p>

<p>Uns fois <strong>Opa</strong> téléchargé et installé, vous devriez avoir tout ce dont vous avez besoin. Il n'y a pas d'autres dépendances à installer (<strong>Node.js</strong> étant automatiquement installé par <strong>Opa</strong> s'il n'est pas détecté durant la phase de configuration).</p>

<h4>Le squelette de l'application.</h4>

<p><strong>Opa</strong> est livré avec un outil permettant de générer un squelette d'application basé sur le modèle <strong>MVC</strong>.</p>

<p>Ouvrez une console, placez vous à l'endroit souhaité et tappez simplement</p>

<p><code>opa create snippets</code></p>

<p>où <em>snippets</em> est le nom de notre application.</p>

<p>Cela va créer un repertoire <em>snippets</em> comprenant le squelette de notre application (pour plus de détails sur cet outil, regardez <a href="http://blog.opalang.org/2012/06/programming-tools-ux-how-we-simplified.html">l'article de Cédric Soulas sur le blog d'opalang</a>).</p>

<h4>La configuration.</h4>

<p>Un fichier nommé <code>opa.conf</code> est placé à la racine de l'application et décrit les importations nécessaires pour chaque fichier, que ce soit l'importation d'éléments de la librairie standard d'<strong>Opa</strong> ou d'un des autres fichiers source de l'application. Éditez ce fichier et modifier-le comme ceci :</p>

<div class="highlight"><pre><span class="nx">snippets</span><span class="p">.</span><span class="nx">controller</span><span class="o">:</span>
    <span class="kr">import</span> <span class="nx">snippets</span><span class="p">.</span><span class="nx">view</span>
    <span class="kr">import</span> <span class="nx">snippets</span><span class="p">.</span><span class="nx">model</span> <span class="c1">// nouvelle ligne ajoutée</span>
    <span class="nx">src</span><span class="o">/</span><span class="nx">controller</span><span class="p">.</span><span class="nx">opa</span>

<span class="nx">snippets</span><span class="p">.</span><span class="nx">view</span><span class="o">:</span>
    <span class="kr">import</span> <span class="nx">snippets</span><span class="p">.</span><span class="nx">model</span>
    <span class="kr">import</span> <span class="nx">stdlib</span><span class="p">.</span><span class="nx">themes</span><span class="p">.</span><span class="nx">bootstrap</span>
    <span class="nx">src</span><span class="o">/</span><span class="nx">view</span><span class="p">.</span><span class="nx">opa</span>

<span class="nx">snippets</span><span class="p">.</span><span class="nx">model</span><span class="o">:</span>
    <span class="nx">src</span><span class="o">/</span><span class="nx">model</span><span class="p">.</span><span class="nx">opa</span>
</pre></div>

<p>En ajoutant la ligne <code>import snippets.model</code>, nous avons indiqué au compilateur que le module <strong>Controller</strong> du fichier <code>src/controller.opa</code> a besoin de connaître certaines fonctions définies dans le module <strong>Model</strong> du fichier <code>src/model.opa</code>.</p>

<p>Notez que ces déclarations peuvent aussi bien se faire en début de chaque fichier. Mais l'utilisation d'un fichier <code>opa.conf</code> a l'avantage de centraliser toutes les déclarations de ce type.</p>

<h4>Le modèle.</h4>

<p>Une fois le squelette créé, nous commençons par modifier le fichier <code>src/model.opa</code> pour y inclure la définition d'un <em>snippet</em> et les traitements associés.</p>

<div class="highlight"><pre><span class="nx">type</span> <span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="p">{</span><span class="nx">option</span><span class="p">(</span><span class="kr">int</span><span class="p">)</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">user</span><span class="p">}</span>

<span class="nx">module</span> <span class="nx">Model</span> <span class="p">{</span>

    <span class="c1">// the user context that will store the list of snippets</span>
    <span class="nx">UserContext</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="nx">list</span><span class="p">(</span><span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span><span class="p">))</span> <span class="nx">snippets</span> <span class="o">=</span> <span class="nx">UserContext</span><span class="p">.</span><span class="nx">make</span><span class="p">([]);</span>

    <span class="kd">function</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">none</span><span class="p">},</span> <span class="o">~</span><span class="nx">title</span><span class="p">,</span> <span class="o">~</span><span class="nx">code</span><span class="p">,</span> <span class="o">~</span><span class="nx">user</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">match</span> <span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">id</span><span class="p">}</span><span class="o">:</span> <span class="c1">// existing snippet</span>
        <span class="nx">UserContext</span><span class="p">.</span><span class="nx">change</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">snippets</span> <span class="o">=</span> <span class="nx">List</span><span class="p">.</span><span class="nx">remove_p</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">id</span><span class="p">}}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">cons</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="c1">// applying the callback onto the given snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="k">default</span><span class="o">:</span> <span class="c1">// new snippet</span>
        <span class="nx">l</span> <span class="o">=</span> <span class="nx">UserContext</span><span class="p">.</span><span class="nx">execute</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span><span class="nx">List</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="p">{</span><span class="nx">snippet</span> <span class="kd">with</span> <span class="o">~</span><span class="nx">id</span><span class="p">}</span>
        <span class="nx">UserContext</span><span class="p">.</span><span class="nx">change</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// the list is reinitiallized every 5 snippets</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">[</span><span class="nx">snippet</span><span class="p">]</span>
        <span class="k">else</span> <span class="nx">List</span><span class="p">.</span><span class="nx">cons</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">snippets</span><span class="p">)</span>
        <span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="c1">// applying the callback onto the updated snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">match</span> <span class="p">(</span><span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">snippet</span><span class="p">}</span> <span class="o">:</span>
        <span class="nx">UserContext</span><span class="p">.</span><span class="nx">change</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">remove_p</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="c1">// applying the callback onto the found snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="k">default</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">source</span><span class="p">(</span><span class="s2">"\{\"toto\":\"ERROR\"}"</span><span class="p">,</span> <span class="s2">"application/json"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">find_all</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">UserContext</span><span class="p">.</span><span class="nx">execute</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">UserContext</span><span class="p">.</span><span class="nx">execute</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}),</span> <span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<p>Ce fichier ne présente pas de grandes difficultés si vous êtes familiers avec <strong>Opa</strong> et la programmation fonctionnelle.</p>

<p>La seule particularité est l'utilisation du <strong>UserContext</strong>. Ce module, appartenant à la librairie standard d'<strong>Opa</strong>, est un des moyens offerts par <strong>Opa</strong> permettant la création et la manipulation d'éléments mutables.</p>

<h4>La vue.</h4>

<p>Nous allons maintenant éditer le ficher <code>src/view.opa</code> pour définir la structure de la page.</p>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">View</span> <span class="p">{</span>

    <span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">snippet_one</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 1"</span><span class="p">,</span><span class="s2">"//FOO"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
    <span class="nx">snippet_two</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 2"</span><span class="p">,</span><span class="s2">"//Hello World"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
    <span class="nx">snippet_three</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 3"</span><span class="p">,</span><span class="s2">"//Me again !"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">jlog</span><span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_one</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_two</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_three</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">simple_main_page</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">content</span> <span class="o">=</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onready</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">initialize</span><span class="p">()}}</span><span class="o">&gt;</span> <span class="c1">// on initialise la liste de snippets au chargement de la page</span>
    <span class="o">&lt;</span><span class="err">/div&gt;;</span>
    <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>Notez ici que vous pouvez écrire directement du code HTML dans du code <strong>Opa</strong>. La création de pages web en <strong>Opa</strong> n'etant pas le sujet de ce tutoriel, nous nous contenterons d'une simple page vierge suffisante au bon déroulement de notre application. Il faut juste penser à créer les premiers <em>snippets</em> au chargement de la page.</p>

<h4>Le contrôleur.</h4>

<p>Il nous reste maintenant à gérer la définition du serveur, le dispatcheur (ou routeur) et le traitements des requêtes <strong>REST</strong>.
Cela se fait dans le fichier <code>src/controller.opa</code>, que nous allons éditer et modifier comme cela :</p>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">Controller</span> <span class="p">{</span>

   <span class="kd">function</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">){</span>
            <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">snippet</span><span class="p">));</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">parse_query</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">HttpRequest</span><span class="p">.</span><span class="nx">get_body</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">body</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">p</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
                <span class="o">|</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">UriParser</span><span class="p">.</span><span class="nx">query_element</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
        <span class="p">};</span>
        <span class="nx">Parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">default</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">create_snippet</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">value</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
            <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet creation"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">update_snippet</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">partial_unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">json</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">unserialize_unsorted</span><span class="p">(</span><span class="nx">json</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">snippet</span><span class="p">}</span> <span class="o">:</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet update"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="k">default</span><span class="o">:</span>  <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet update"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">value</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">Model</span><span class="p">.</span><span class="nx">delete_snippet</span><span class="p">({</span><span class="nx">some</span><span class="o">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">id</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">){</span>
            <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">snippet</span><span class="p">));</span>
            <span class="p">});</span>
            <span class="k">default</span><span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet deletion"</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">get_snippet</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
            <span class="o">|</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">UriParser</span><span class="p">.</span><span class="nx">query</span> <span class="o">-&gt;</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">[(</span><span class="s2">"model"</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="o">|</span> <span class="nx">_</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="nx">match</span> <span class="p">(</span><span class="nx">Json</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">Record</span><span class="o">:</span> <span class="p">[(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span><span class="nx">Int</span> <span class="o">:</span> <span class="nx">id</span><span class="p">})]}}</span><span class="o">:</span>
                <span class="nx">match</span> <span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">find_by_id</span><span class="p">({</span><span class="nx">some</span><span class="o">:</span> <span class="nx">id</span><span class="p">}))</span> <span class="p">{</span>
                <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">snippet</span><span class="p">}</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">snippet</span><span class="p">));</span>
                <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet get"</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="k">default</span><span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet get"</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">}</span>
            <span class="k">default</span> <span class="o">-&gt;</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet get"</span><span class="p">)</span>
        <span class="p">}</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">source</span><span class="p">(</span><span class="s2">"\{\"toto\":\"POST KO\"}"</span><span class="p">,</span> <span class="s2">"application/json"</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">Parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">get_all_snippets</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">find_all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">){</span>
        <span class="nx">list</span> <span class="o">=</span> <span class="nx">List</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)}),</span> <span class="nx">snippets</span><span class="p">);</span>
        <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nx">List</span> <span class="o">:</span> <span class="nx">list</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="p">}</span>

    <span class="cm">/*  LE SERVEUR AVEC LE GESTIONNAIRE DE REQUETES */</span>

    <span class="nx">dispatcher</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
            <span class="o">|</span> <span class="s2">"/"</span> <span class="o">-&gt;</span> <span class="nx">View</span><span class="p">.</span><span class="nx">simple_main_page</span><span class="p">()</span>
            <span class="o">|</span> <span class="s2">"/snippets"</span> <span class="o">-&gt;</span> <span class="nx">get_all_snippets</span><span class="p">();</span>
            <span class="o">|</span> <span class="s2">"/snippet"</span> <span class="nx">path</span><span class="o">=</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">HttpRequest</span><span class="p">.</span><span class="nx">get_method</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">post</span><span class="p">}}</span><span class="o">:</span> <span class="nx">create_snippet</span><span class="p">();</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">put</span><span class="p">}}</span><span class="o">:</span> <span class="nx">update_snippet</span><span class="p">();</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">get</span><span class="p">}}</span><span class="o">:</span> <span class="nx">get_snippet</span><span class="p">(</span><span class="nx">Text</span><span class="p">.</span><span class="nx">to_string</span><span class="p">(</span><span class="nx">path</span><span class="p">));</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="k">delete</span><span class="p">}}</span><span class="o">:</span> <span class="nx">delete_snippet</span><span class="p">();</span>
            <span class="k">default</span><span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during method inspection"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span> <span class="o">&lt;&gt;&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="s2">"404 NOT FOUND!"</span><span class="o">&lt;</span><span class="sr">/h2&gt;&lt;/</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">Server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">Server</span><span class="p">.</span><span class="nx">http</span><span class="p">,</span> <span class="p">{</span><span class="nx">custom</span> <span class="o">:</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">})</span>
</pre></div>

<p>Ce fichier présente plusieurs concepts clés que nous allons regarder de plus près.</p>

<h5>Le traitement des requêtes et méthodes HTTP :</h5>

<p>Un serveur <strong>Opa</strong> est associé à un gestionnaire d'URL, ou routes. La gestion des routes se fait via un <em>parser</em> d'<strong>URL</strong> : en fonction de l'<strong>URL</strong> reçue on redirige vers des traitements ou des pages spécifiques. C'est  l'équivalent <strong>Opa</strong> de l'objet <strong>app.routes</strong> de <strong>Express.js</strong> et de la classe <strong>Router</strong> de <strong>Backbone.js</strong>. La variable <em>dispatcher</em> s'occupe de cela.</p>

<div class="highlight"><pre>    <span class="nx">dispatcher</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
            <span class="o">|</span> <span class="s2">"/"</span> <span class="o">-&gt;</span> <span class="nx">View</span><span class="p">.</span><span class="nx">simple_main_page</span><span class="p">()</span>
            <span class="o">|</span> <span class="s2">"/snippets"</span> <span class="o">-&gt;</span> <span class="nx">get_all_snippets</span><span class="p">();</span>
            <span class="o">|</span> <span class="s2">"/snippet"</span> <span class="nx">path</span><span class="o">=</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">HttpRequest</span><span class="p">.</span><span class="nx">get_method</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">post</span><span class="p">}}</span><span class="o">:</span> <span class="nx">create_snippet</span><span class="p">();</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">put</span><span class="p">}}</span><span class="o">:</span> <span class="nx">update_snippet</span><span class="p">();</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="nx">get</span><span class="p">}}</span><span class="o">:</span> <span class="nx">get_snippet</span><span class="p">(</span><span class="nx">Text</span><span class="p">.</span><span class="nx">to_string</span><span class="p">(</span><span class="nx">path</span><span class="p">));</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="p">{</span><span class="k">delete</span><span class="p">}}</span><span class="o">:</span> <span class="nx">delete_snippet</span><span class="p">();</span>
            <span class="k">default</span><span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during method inspection"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span> <span class="o">&lt;&gt;&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="s2">"404 NOT FOUND!"</span><span class="o">&lt;</span><span class="sr">/h2&gt;&lt;/</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>

<p>La gestion des requêtes de type <strong>REST</strong> se fait ici en récupérant la méthode associée à la requête reçue (grâce à la fonction <strong>HttpRequest.get_method()</strong> de la librairie standard d'<strong>Opa</strong>) et d'effectuer un traitement spécifique en fonction de la méthode employée. On effectue pour ce faire un <em>pattern-matching</em> sur le résultat renvoyé : en fonction du résultat retourné, on applique une fonction spécifique.</p>

<p>Par exemple, dans le cas de la réception d'une requête <strong>POST</strong>, la fonction <strong>HttpRequest.get_method()</strong> retourne la valeur <code>{some : {post}}</code> et l'on voit que le <em>dispatcher</em> associe à cette valeur la fonction <strong>create_snippet</strong> :</p>

<div class="highlight"><pre><span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="p">{</span><span class="nx">post</span><span class="p">}}</span><span class="o">:</span> <span class="nx">create_snippet</span><span class="p">();</span>
</pre></div>

<p>Regardons plus en détails le code de cette fonction :</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">create_snippet</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">value</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
            <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet creation"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<p>La fonction <strong>create_snippet</strong> fait un appel à la fonction <strong>parse_query</strong> en lui donnant une fonction de traitement (que nous allons détailler plus loin). Regardons d'abord le corps de la fonction <strong>parse_query</strong> :</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">parse_query</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">HttpRequest</span><span class="p">.</span><span class="nx">get_body</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">body</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">p</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
                <span class="o">|</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">UriParser</span><span class="p">.</span><span class="nx">query_element</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="o">:</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
            <span class="p">}</span>
            <span class="p">}</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
        <span class="p">};</span>
        <span class="nx">Parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">default</span> <span class="o">:</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="nb">String</span> <span class="o">:</span> <span class="s2">"ERROR DURING REQUEST PARSING"</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p>Nous avons besoin de récupérer le corps de la requête (grâce à la fonction <strong>HttpRequest.get_body()</strong> de la librairie standard d'<strong>Opa</strong>). Une fois ce corps récupéré, il faut l'analyser pour en extraire les éléments constituants la requête, ce qui est fait ici grâce à un <em>parser</em> d'<strong>URI</strong>, et enfin appliquer une fonction de traitement (<em>callback</em>, donné en paramètre de la fonction) sur ces éléments.</p>

<h5>Le traitement des données JSON.</h5>

<p>Nous venons de voir comment les éléments constituants la requête avaient été récupérés. Regardons maintenant comment nous pouvons manipuler ces éléments.</p>

<p>Reprenons le code de la fonction <strong>create_snippet</strong> :</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">create_snippet</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nb">String</span><span class="p">.</span><span class="nx">unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">value</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
            <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet creation"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<p>Les éléments constituants la requête sont récupérés sous la forme d'une chaîne de caractères représentant une donnée au format JSON. Nous devons donc décoder cette chaîne de caractères pour récupérer un élément manipulable. Cela est fait par l'appel à la fonction <strong>OpaSerialize.String.unserialize</strong> qui prend en paramètre la chaîne de caractères et retourne un <em>record</em> correspondant. Nous pouvons donc maintenant créer un nouveau <em>snippet</em> à partir des champs <strong>title</strong>, <strong>code</strong> et <strong>user</strong> du <em>record</em> précédemment créé, et le sauvegarder.</p>

<p>Notez que l'on peut aussi, à partir d'une chaîne de caractères représentant un objet d'un type Opa connu décrit au format JSON, construire directement l'objet correspondant. Cela est par exemple fait dans la fonction <strong>update_snippet</strong> :</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">update_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">parse_query</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">partial_unserialize</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">json</span><span class="p">}</span> <span class="o">:</span>
            <span class="nx">match</span> <span class="p">(</span><span class="nx">OpaSerialize</span><span class="p">.</span><span class="nx">Json</span><span class="p">.</span><span class="nx">unserialize_unsorted</span><span class="p">(</span><span class="nx">json</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">snippet</span><span class="p">}</span> <span class="o">:</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span>
            <span class="k">default</span> <span class="o">:</span> <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet update"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="k">default</span><span class="o">:</span>  <span class="nx">error</span><span class="p">(</span><span class="s2">"error during snippet update"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<p>A partir de la chaîne de caractères, on construit un objet de type <em>RPC.Json.json</em> grâce à la fonction <strong>OpaSerialize.partial_unserialize</strong>. Il nous reste à décoder cet objet grâce à la fonction <strong>OpaSerialize.Json.unserialize_unsorted</strong> (<em>unsorted</em> car les champs dans la requête ne sont pas triés). Nous obtenons alors directement un objet du type <em>Snippet.t</em> que nous pouvons donc sauvegarder.</p>

<h4>Testons cette application.</h4>

<p>Nous avons donc terminé notre petite application, c'est le moment de la tester.
Ouvrez un navigateur internet, ouvrez la console JavaScript et entrez les commandes suivantes :</p>

<h5>Création de snippet.</h5>

<div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"/snippet"</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="o">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span><span class="s2">"Hello World"</span><span class="p">,</span>
        <span class="nx">code</span> <span class="o">:</span> <span class="s2">"println('Hello world')"</span><span class="p">,</span>
        <span class="nx">user</span> <span class="o">:</span> <span class="s2">"@gregmak"</span>
    <span class="p">})},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"oups"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataFromServer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v1/post.png?raw=true" alt="post.png"></p>

<p>On remarque que le serveur nous a renvoyé l'objet créé avec un nouvel <em>id</em> associé. Comme nous avions défini 3 <em>snippets</em>, le nouveau <em>snippet</em> a été créé avec l'<em>id</em> 4.</p>

<h5>Mise à jour de snippet.</h5>

<div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">"PUT"</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"/snippet"</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="o">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="nx">id</span> <span class="o">:</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="mi">4</span><span class="p">},</span> <span class="cm">/*vérifier que l'id existe*/</span>
        <span class="nx">title</span><span class="o">:</span><span class="s2">"Hello World"</span><span class="p">,</span>
        <span class="nx">code</span> <span class="o">:</span> <span class="s2">"println('Hello world $name')"</span><span class="p">,</span>
        <span class="nx">user</span> <span class="o">:</span> <span class="s2">"@GREGMAK"</span>
    <span class="p">})},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"oups"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataFromServer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v1/put.png?raw=true" alt="put.png"></p>

<p>Le serveur nous a renvoyé l'objet avec le champ <em>user</em> ayant la nouvelle valeur.</p>

<h5>Recherche de snippet.</h5>

<div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">"GET"</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"/snippet"</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="o">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="mi">1</span><span class="p">})},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"oups"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataFromServer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v1/get.png?raw=true" alt="get.png"></p>

<p>Le serveur nous a bien renvoyé le <em>snippet</em> d'<em>id</em> 1.</p>

<h5>Suppression de snippet.</h5>

<div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">"DELETE"</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"/snippet"</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span><span class="s2">"model"</span><span class="o">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="mi">1</span><span class="p">})},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"oups"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dataFromServer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v1/delete.png?raw=true" alt="delete.png"></p>

<h5>Liste de tous les snippet.</h5>

<div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">"GET"</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">"/snippets"</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"oups"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dataFromServer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dataFromServer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v1/getAll.png?raw=true" alt="getAll.png"></p>

<p>Le serveur nous a renvoyé une liste de 3 <em>snippets</em>, le <em>snippet</em> d'<em>id</em> 1 ayant été supprimé précédemment.</p>

<h4>Conclusion.</h4>

<p>Nous venons de voir comment gérer les requêtes <strong>REST</strong> en <strong>Opa</strong> en comparaison de ce qui est fait par le framework <strong>Express.js</strong>.</p>

<p>Nous verrons dans d'autres tutoriels comment :</p>

<ul>
<li>manipuler le <strong>DOM</strong> afin de synchroniser les modèles et les vues associées,</li>
<li>gérer la persistance via l'utilisation d'une base de données <strong>NoSQL</strong> (en l'occurrence <strong>MongoDB</strong>),</li>
<li>etc.</li>
</ul><h2>Manipulation du DOM.</h2>

<p>Nous allons voir dans ce tutoriel comment manipuler le DOM en <strong>Opa</strong>.
Pour ce faire nous allons reprendre l'application ecrite précédamment et nous allons la modifier pour :</p>

<ol>
<li>permettre à l'utilisateur de créer ses <em>snippets</em> via un formulaire plutôt que via des requêtes <strong>REST</strong>
</li>
<li>que les <em>snippets</em> soient affichés dans la page web plutôt que dans la console du navigateur.</li>
</ol><p>Nous avons donc besoin d'une part d'un formulaire et d'autre part d'afficher une liste de <em>snippets</em> qui va se mettre à jour au fur et à mesure des créations de <em>snippets</em>.</p>

<h4>Le modèle.</h4>

<p>Le code du modèle ne change pas.
Nous allons donc passer directement à la vue, c'est-à-dire la gestion de l'affichage de la page web.
Reportez-vous au précédent tutoriel pour voir le code du modèle.</p>

<h4>La vue.</h4>

<p>Nous allons maintenant éditer le ficher <code>src/view.opa</code> pour définir la structure de la page.
Cette structure a changé car nous voulons maintenant afficher les <em>snippets</em> crées directement dans la page web.</p>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">View</span> <span class="p">{</span>

    <span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">snippet_one</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 1"</span><span class="p">,</span><span class="s2">"//FOO"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
    <span class="nx">snippet_two</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 2"</span><span class="p">,</span><span class="s2">"//Hello World"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
    <span class="nx">snippet_three</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 3"</span><span class="p">,</span><span class="s2">"//Me again !"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_one</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_two</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_three</span><span class="p">,</span> <span class="nx">foo</span><span class="p">);</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span>
        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span> <span class="nx">by</span> <span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h2&gt;&lt;br&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">Markdown</span><span class="p">.</span><span class="nx">xhtml_of_string</span><span class="p">({</span><span class="nx">detect_text_links</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">snippet</span><span class="p">.</span><span class="nx">code</span><span class="p">)}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/li&gt;;</span>
    <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">snippet</span><span class="o">-</span><span class="nx">list</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">content</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">append</span><span class="p">}}])</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">add_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
    <span class="nx">code</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">)</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">All</span> <span class="nx">fields</span> <span class="nx">are</span> <span class="nx">mandatory</span><span class="p">.</span> <span class="nx">Please</span> <span class="nx">fill</span> <span class="nx">them</span> <span class="nx">all</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">simple_main_page</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">title_bar</span> <span class="o">=</span>
        <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"navbar navbar-fixed-top"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"navbar-inner"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"brand"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span>
        <span class="o">&lt;&gt;</span><span class="nx">OPA</span><span class="o">&lt;</span><span class="err">/&gt;</span>
        <span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/&gt;;</span>
    <span class="nx">form</span> <span class="o">=</span>
        <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet-form"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"margin-top:50px;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Go</span> <span class="p">...</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
        <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">"post"</span> <span class="nx">action</span><span class="o">=</span><span class="s2">"javascript:void(0);"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"well"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Title</span> <span class="o">:</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"title"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"span3"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"title"</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Code</span> <span class="nx">Snippet</span> <span class="o">:</span> <span class="p">(</span><span class="kd">with</span> <span class="nx">markdown</span><span class="p">)</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"code"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"code"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"width:100%"</span> <span class="nx">rows</span><span class="o">=</span><span class="s2">"5"</span><span class="o">&gt;&lt;</span><span class="err">/textarea&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">User</span> <span class="o">:</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"user"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"user"</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"btn"</span> <span class="nx">onclick</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">add_snippet</span><span class="p">()}}</span><span class="o">&gt;</span><span class="nx">Ajouter</span> <span class="nx">un</span> <span class="nx">Snippet</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
        <span class="o">&lt;</span><span class="err">/form&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/&gt;;</span>
    <span class="nx">content</span> <span class="o">=</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onready</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">initialize</span><span class="p">()}}</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">title_bar</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">form</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet-list"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"list-style: none;"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">data</span><span class="o">-</span><span class="nx">template</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">/li&gt;</span>
        <span class="o">&lt;</span><span class="err">/ul&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"notifications"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;;</span>
    <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"StyKKeKode in OPA"</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<h5>La structure de la page.</h5>

<p>Nous voyons que la structure de la page est un peu plus complèxe que dans le tutoriel précédent, dans lequel nous nous contentions d'une simple page blanche.
Notre page se compose maintenant d'une barre de titre, d'un formulaire de création de <em>snippets</em> et d'un emplacement pour afficherla liste des <em>snippets</em>.</p>

<p>La barre de titre sert à donner un rendu à la page et permet d'avoir un lien permanent vers une des pages (par exemple la page d'acceuil) de l'application.</p>

<p>La création du formulaire ne présente pas de difficultés particulières si vous avez déjà ecrits des formulaires HTML.
Il vous faut préciser la méthode à utiliser pour envoyer les données vers le serveur : <strong>get</strong> ou <strong>post</strong> (ce tutoriel ne portant pas sur les différences entre ces méthodes, je ne les détaillerai pas ici), puis définir les champs qui composeront votre formulaire.
Nous avons besoin ici de 3 champs de saisie (pour le titre du <em>snippet</em>, le code du <em>snippet</em> et le nom de l'utilisateur), ainsi que d'un bouton pour valider le formulaire et envoyer les données au serveur.
Le titre et le nom de l'utilisateur seront renseignés dans deux <strong>input</strong> et le code du <em>snippet</em> dans un <strong>textarea</strong>.
Au bouton de soumission est associée la méthode <strong>add_snippet()</strong> qui va lire les données dans les champs du formulaire et les envoyer au serveur pour que celui-ci puisse créer un nouveau <em>snippet</em>.</p>

<p>Regardons le code de cette fonction plus en détails.</p>

<h5>La récupération d'informations.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">add_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
    <span class="nx">code</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">)</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">All</span> <span class="nx">fields</span> <span class="nx">are</span> <span class="nx">mandatory</span><span class="p">.</span> <span class="nx">Please</span> <span class="nx">fill</span> <span class="nx">them</span> <span class="nx">all</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p>La manipulation du DOM se fait en <strong>Opa</strong> via les fonctions du module Dom de la librairie standard.
La récupération d'informations dans une page web se fait grâce à la méthode <strong>Dom.get_value</strong> qui prend en paramètre un élément de type <strong>dom</strong> et retourne une chaîne de caractères.
Dans notre exemple, nous nous servons des identifiants pour récupérer les valeurs qui nous interressent. Ce n'est pas la seule façon de faire
(ni même forcément la meilleure dans le sens où cela neccessite une gestion rigoureuse des identifiants pour éviter toute dupplication).</p>

<p>Prenons l'exemple du titre du <em>snipet</em>.
Dans la structure du formulaire nous avons déclaré le champ de saisie ainsi : <code>&lt;input id="title" type="text" class="span3" placeholder="title"/&gt;</code>.
Nous lui avons donc associé l'identifiant <em>title</em> : <code>id="title"</code>.
Nous récupérons le titre entré par l'appel à la fonction Dom.get_value() en lui donnant en paramètre le champ concerné, ici récupéré via son identifiant <em>title</em> : <code>Dom.get_value(#title)</code>`
(simillairement à JQuery, la syntaxe <em>#id</em> fait référence à l'élément d'identifiant <em>id</em> contenu dans la page s'il existe).
Les champs récupérés peuvent se manipuler directement, sans traitement particulier, sous forme de chaîne de caractères car ils sont de ce type dans notr définition du type d'un <em>snippet</em>.</p>

<p>Une fois toues les données necessaires récupérées, nous les envoyons au serveur afin qu'il créé un nouveau <em>snippet</em>, puis efface les données du formulaire et met à jour la vue pour qu'elle soit synchronisée avec le modèle.</p>

<div class="highlight"><pre>        <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
        <span class="p">});</span>
</pre></div>

<p>La mise à jour de l'affichage de la liste des <em>snippets</em> se fait par l'appel à la fonction <strong>dispay_snippet</strong> en lui donnant en paramètre le <em>sippet</em> à afficher en plus de ceux déjà affichés.</p>

<p>Regardons le code de cette fonction plus en détails.</p>

<h5>La mise à jour de la vue.</h5>

<pre lang="javascipt"><code>    function display_snippet(snippet) {
    content =
        &lt;li&gt;
            &lt;h2&gt;{snippet.title} by {snippet.user}&lt;/h2&gt;&lt;br&gt;
        &lt;div&gt;{Markdown.xhtml_of_string({detect_text_links: true}, snippet.code)}&lt;/div&gt;
        &lt;/li&gt;;
    Dom.transform([{jq : #snippet-list, subject : {content : content}, verb : {append}}])
    }
</code></pre>

<p>La mise à jour de la vue en fonction du modèle est assez simple.
Nous construisons le nouvel élément à insérer puis nous mettons à jour la liste des snippets.</p>

<p>Nous avons défini à la création de notre page un endroit où afficher la liste des <em>snippets</em> contenus dans le modèle :</p>

<div class="highlight"><pre>        <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet-list"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"list-style: none;"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">data</span><span class="o">-</span><span class="nx">template</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">/li&gt;</span>
        <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</pre></div>

<p>Nous avons juste besoin d'indiquer au DOM que cette liste va contenir un nouvel élément qui est le nouveau snippet. Donc, concrètement, qu'il faut ajouter un nouvel élément <em>&lt;li&gt;...&lt;/li&gt;</em> à l'élément <em><ul>...</ul></em>.</p>

<div class="highlight"><pre><span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">snippet</span><span class="o">-</span><span class="nx">list</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">content</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">append</span><span class="p">}}])</span>
</pre></div>

<p>La fonction <strong>Dom.transform</strong> prend en argument un élément de type <strong>dom</strong> à modifier (que nous récupérons ici grâce à son identifiant <em>snippet-list</em>), et la façon de le modifier (cela peut être un ajout à la fin, un ajout au début ou un remplacement).
Dans notre exemple nous utilisons la valeur <code>{append}</code> qui indique que l'on veut ajouter du contenu à la fin.</p>

<h5>Gestion d'erreurs.</h5>

<p>Nous avons ajouté dans notre exemple un premier niveau de gestion d'erreur.
Dans le cas où tous les champs ne sont pas renseignés, un message d'erreur s'affiche sur la page web et aucune données n'est transmise au serveur.
Cela permet d'avoir un contrôle sur la structure du formulaire côté client, sans avoir besoin d'envoyer une requête au serveur pour s'appercevoir que des données sont manquantes.
Cela ne permet pas en revanche de s'affranchir d'un contrôle plus rigoureux des données côté serveur.</p>

<div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">All</span> <span class="nx">fields</span> <span class="nx">are</span> <span class="nx">mandatory</span><span class="p">.</span> <span class="nx">Please</span> <span class="nx">fill</span> <span class="nx">them</span> <span class="nx">all</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
    <span class="p">}</span>
</pre></div>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v2/snippets_v2_error_server.png?raw=true" alt="snippets_v2_error_server.png"></p>

<h4>Le controlleur.</h4>

<p>Dans cette version le code du controlleur est beaucoup plus simple et court car nous n'avons plus besoin des traiter des requêtes <strong>REST</strong>.
Un simple parser d'URL permet de faire tourner notre application (nous n'avons qu'une page à servir).</p>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">Controller</span> <span class="p">{</span>

    <span class="nx">dispatcher</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
            <span class="o">|</span> <span class="s2">"/"</span> <span class="o">-&gt;</span> <span class="nx">View</span><span class="p">.</span><span class="nx">simple_main_page</span><span class="p">()</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span> <span class="o">&lt;&gt;&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="s2">"404 NOT FOUND!"</span><span class="o">&lt;</span><span class="sr">/h2&gt;&lt;/</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">Server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">Server</span><span class="p">.</span><span class="nx">http</span><span class="p">,</span> <span class="p">{</span><span class="nx">custom</span> <span class="o">:</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">dispatcher</span><span class="p">})</span>
</pre></div>

<h4>Testons cette application.</h4>

<p>Une fois l'application compilée et lancée, ouvrez votre navigateur à l'adresse indiquée.
Vous voyez que la page affiche déjà les 3 <em>snippets</em> qu'on a créé au lancement du serveur. Le modèle et la vue sont donc bien synchronisés au démarrage du serveur.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v2/snippets_v2_1.png?raw=true" alt="snippets_v2_1.png"></p>

<p>Entrez un titre et un code pour votre <em>sinppet</em>, votre nom et cliquez sur le bouton 'Ajouter un snippet'.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v2/snippets_v2_2.png?raw=true" alt="snippets_v2_2.png"></p>

<p>Vous voyez que la vue a bien été mise à jour avec votre nouveau snippet affiché en fin de liste.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v2/snippets_v2_3.png?raw=true" alt="snippets_v2_3.png"></p>

<h4>Conclusion.</h4>

<p>Nous venons de voir comment manipuler le DOM en <strong>Opa</strong> en comparaison de ce qui est fait par le framework <strong>Backbone.js</strong>.</p>

<p>Nous verrons dans d'autres tutoriels comment :</p>

<ul>
<li>gérer la persistance via l'utilisation d'une base de données <strong>NoSQL</strong> (en l'occurrence <strong>MongoDB</strong>),</li>
<li>etc.</li>
</ul><h2>Persistance avec MongoDB.</h2>

<p>Nous allons voir dans ce tutoriel comment gérer la persistance en <strong>Opa</strong> via l'utilisation d'une base de données NoSQL : <strong>MongoDB</strong>.
Pour ce faire nous allons reprendre l'application ecrite précédamment et nous allons la modifier pour que les <em>snippets</em> créés soient stockés dans une base de données plutôt qu'en RAM.</p>

<h4>Le modèle.</h4>

<p>Cette fois le code du modèle va changer par rapport à la première version de l'application.
Nous y déclarons maintenant notre base de données, ainsi que toutes les fonctions de manipulation de <em>snippets</em>.</p>

<div class="highlight"><pre><span class="nx">type</span> <span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="p">{</span><span class="nx">option</span><span class="p">(</span><span class="kr">int</span><span class="p">)</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">user</span><span class="p">}</span>

<span class="nx">database</span> <span class="nx">test</span> <span class="p">{</span>
    <span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span> <span class="o">/</span><span class="nx">snippets</span><span class="p">[{</span><span class="nx">id</span><span class="p">}]</span> <span class="c1">// the set of snippets</span>
<span class="p">}</span>

<span class="nx">module</span> <span class="nx">Model</span> <span class="p">{</span>

    <span class="kd">function</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">none</span><span class="p">},</span> <span class="o">~</span><span class="nx">title</span><span class="p">,</span> <span class="o">~</span><span class="nx">code</span><span class="p">,</span> <span class="o">~</span><span class="nx">user</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">match</span> <span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">_</span><span class="p">}</span><span class="o">:</span>
        <span class="err">/test/snippets[{id : snippet.id}] &lt;- snippet;</span>
        <span class="c1">// applying the callback onto the given snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="k">default</span><span class="o">:</span> <span class="c1">// new snippet</span>
        <span class="nx">size</span> <span class="o">=</span> <span class="nx">Iter</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">DbSet</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="err">/test/snippets));</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">};</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="p">{</span><span class="nx">snippet</span> <span class="kd">with</span> <span class="o">~</span><span class="nx">id</span><span class="p">};</span>
        <span class="err">/test/snippets[{id: id}] &lt;- snippet;</span>
        <span class="c1">// applying the callback onto the updated snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">find_all</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">it</span> <span class="o">=</span> <span class="nx">DbSet</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="err">/test/snippets);</span>
    <span class="nx">snippets</span> <span class="o">=</span> <span class="nx">Iter</span><span class="p">.</span><span class="nx">to_list</span><span class="p">(</span><span class="nx">it</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="err">/test/snippets[{id: {some: id}}];</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">Db</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="err">@</span><span class="o">/</span><span class="nx">test</span><span class="o">/</span><span class="nx">snippets</span><span class="p">[{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span><span class="p">}]);</span>
    <span class="c1">// applying the callback onto the found snippet</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">append</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">find_all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">is_empty</span><span class="p">(</span><span class="nx">snippets</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">snippet_one</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 1"</span><span class="p">,</span><span class="s2">"//FOO"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">snippet_two</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 2"</span><span class="p">,</span><span class="s2">"//Hello World"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">snippet_three</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 3"</span><span class="p">,</span><span class="s2">"//Me again !"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_one</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_two</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_three</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">snippets</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>

<span class="p">}</span>

</pre></div>

<p>Ce code commence avec la déclaration du type d'un <em>snippet</em>. Nous voyons qu'ici un <em>snippet</em> est composé d'un identifiant, d'un titre, d'un code et d'un nom pour le créateur.</p>

<div class="highlight"><pre><span class="nx">type</span> <span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="p">{</span><span class="nx">option</span><span class="p">(</span><span class="kr">int</span><span class="p">)</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">string</span> <span class="nx">user</span><span class="p">}</span>
</pre></div>

<p>Tous ces champs sauf l'identifiant sont des chaînes de caractères. L'identifiant est un entier optionel (c'est-à-dire qu'il peut ne pas être précisé).</p>

<p>Uns fois le(s) type(s) de données définis, nous devons déclarer la structure de notre base de données.</p>

<div class="highlight"><pre><span class="nx">database</span> <span class="nx">test</span> <span class="p">{</span>
    <span class="nx">Snippet</span><span class="p">.</span><span class="nx">t</span> <span class="o">/</span><span class="nx">snippets</span><span class="p">[{</span><span class="nx">id</span><span class="p">}]</span> <span class="c1">// the set of snippets</span>
<span class="p">}</span>
</pre></div>

<p>Nous venons de déclarer une base de données ayant pour nom <em>test</em> et ayant un seul chemin : <em>/snippets[{id}]</em> servant à stocker des données du type <em>Snippet.t</em>.
Ici nous n'avons que des <em>snippets</em> à stocker, notre base peut dont se composer d'un chemin unique.
Cette déclaration indique que l'on veut stocker un <em>set</em> de <em>snippets</em> avec le champ <em>id</em> comme clé primaire.
Ces <em>snippets</em> seront donc récupérés dans la base de donneés par leur identifiant.</p>

<p>Regardons plus en détail les fonctions de manipulation des <em>snippets</em>.</p>

<h5>La recherche de <em>snippets</em>.</h5>

<p>Nous définissons ici une méthode pour récupérer tous les <em>snippets</em> contenus dans la base et une méthode pour récupérer un <em>snippet</em> à partir de son identifiant.</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">find_all</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">it</span> <span class="o">=</span> <span class="nx">DbSet</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="err">/test/snippets);</span>
    <span class="nx">snippets</span> <span class="o">=</span> <span class="nx">Iter</span><span class="p">.</span><span class="nx">to_list</span><span class="p">(</span><span class="nx">it</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">snippets</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="err">/test/snippets[{id: {some: id}}];</span>
    <span class="p">}</span>
</pre></div>

<p>Ces deux fonctions prennent en argument une continuation à appliquer unefois le ou les <em>snippet(s)</em> récupéré(s).</p>

<p>La méthode pour récupérer tous les <em>snippets</em> va lire l'ensmble des <em>snippets</em> sur le chemin <em>/test/snippets</em> sous la forme d'un <em>DbSet</em>.
Nous voulons manipuler ces <em>sniipets</em> sous forme de liste donc nous transformons notre <em>DbSet</em> en liste de <em>snippets</em> en passant par un <em>iterator</em>.</p>

<p>La méthode pour récupérer un <em>snippet</em> particulier prend en plus l'identifiant du <em>snippet</em> rechercher.
Cette méthode va chercher dans l'ensemble des <em>snippets</em> et applique la continuation sur le <em>snippet</em> ayant l'identifiant recherché.</p>

<h6>Attention !!!</h6>

<p>Chaque chemin d'une déclaration de base de données est associée à une valeur par défaut.
Si aucune donnée n'est sotckée au chemin indiqué, la valeur par défaut associée à ce chemin sera retournée.
C'est pourquoi une lecture sur un chemin valide de la base de donneés retourne toujours un résultat.
C'est au programeur de faire attention, en manipulant le résultat retourner, à savoir s'il manipule cette valeur par défaut ou une valeur trouvée dans la base de données.
Nous reverrons ce point plus loin dans la partie sur la gestion de la vue.</p>

<h5>La sauvegarde de <em>snippets</em>.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">match</span> <span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">_</span><span class="p">}</span><span class="o">:</span>
        <span class="err">/test/snippets[{id : snippet.id}] &lt;- snippet;</span>
        <span class="c1">// applying the callback onto the given snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="k">default</span><span class="o">:</span> <span class="c1">// new snippet</span>
        <span class="nx">size</span> <span class="o">=</span> <span class="nx">Iter</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">DbSet</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="err">/test/snippets));</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">};</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="p">{</span><span class="nx">snippet</span> <span class="kd">with</span> <span class="o">~</span><span class="nx">id</span><span class="p">};</span>
        <span class="err">/test/snippets[{id: id}] &lt;- snippet;</span>
        <span class="c1">// applying the callback onto the updated snippet</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p>Comme nous l'avons indiqué précédamment, les <em>snippets</em> seront enregistrés dans la base de données avec leur identifiant comme clé primaire.
L'identifiant d'un <em>snippet</em> est un entier optionel (c'est-à-dire qu'il peut ne pas être rensigné comme c'est le cas à la création d'un nouveau <em>snippet</em>).
Nous devons donc traiter les deux cas lors de l'enregistrement d'un <em>snippet</em> :</p>

<ol>
<li>Le cas où l'identifiant est rensigné (donc enregistrement d'un <em>snippet</em> existant).</li>
<li>Le cas où il n'est pas rensigné (donc enregistrement d'un nouveau <em>snippet</em>).</li>
</ol><p>Nous effectuons donc un <em>pattern-matching</em> sur l'identifiant du <em>snippet</em> à sauvegarder.</p>

<p>Dans le cas où l'identifiant est renseigné, nous avons juste à écraser l'ancien <em>snippet</em> par le nouveau.</p>

<p>Dans le cas où l'identifiant n'est pas connu, nous devons en créér un nouveau et l'assigner au <em>snippet</em> à sauvegarder.
Pour ce faire nous avons besoin de connaitre le nombre de <em>snippets</em> actuellement contenu dans la base de données. Nous passons encore une fois par un <em>iterator</em>.</p>

<div class="highlight"><pre>        <span class="nx">size</span> <span class="o">=</span> <span class="nx">Iter</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="nx">DbSet</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="err">/test/snippets));</span>
</pre></div>

<p>Une fois le nombre de <em>snippets</em> connus, nous pouvons créér notre nouvel identifiant en prennant l'entier suivant ce nombre et ainsi nous assurer que chaque <em>snippet</em> contenu dans la base aura bien un identifiant unique.</p>

<div class="highlight"><pre>        <span class="nx">id</span> <span class="o">=</span> <span class="p">{</span><span class="nx">some</span> <span class="o">:</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">};</span>
</pre></div>

<p>Il ne nous reste plus qu'a assigner ce nouvel identifiant à notre nouveau <em>snippet</em> et l'enregistrer dans la base avec cet identifiant comme clé primaire, puis appliquer la continuation.</p>

<div class="highlight"><pre>    <span class="nx">snippet</span> <span class="o">=</span> <span class="p">{</span><span class="nx">snippet</span> <span class="kd">with</span> <span class="o">~</span><span class="nx">id</span><span class="p">};</span>
    <span class="err">/test/snippets[{id: id}] &lt;- snippet;</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
</pre></div>

<h5>La suppression de <em>snippets</em>.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Db</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="err">@</span><span class="o">/</span><span class="nx">test</span><span class="o">/</span><span class="nx">snippets</span><span class="p">[{</span><span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">id</span><span class="p">}}]))</span> <span class="p">{</span>
        <span class="nx">Db</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="err">@</span><span class="o">/</span><span class="nx">test</span><span class="o">/</span><span class="nx">snippets</span><span class="p">[{</span><span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">some</span><span class="o">:</span> <span class="nx">id</span><span class="p">}}]);</span>
        <span class="nx">callback</span><span class="p">({</span><span class="nx">ok</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">({</span><span class="nx">ko</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p>La suppression d'un <em>snippet</em> n'est pas très compliquée.
Nous testons l'existence du <em>snippet</em> ayant l'identifiant donné. S'il existe, nous le supprimons et indiquons que la suppression a été faite (<code>callback({ok})</code>). Sinon, nous indiquons que la suppression ne s'est pas faire (<code>callback({ko})</code>).</p>

<h5>L'initialisation.</h5>

<p>Au démarrage de notre serveur, nous regardons le contenu de notre base de données par un appel à la fonction <em>find_all()</em>.
Si la liste retournée est vide, nous créons trois <em>snippets</em> pour remplir la base et nous les affichons.
Dans le cas contraire, la base est déjà remplie de quelques <em>snippets</em> que nous affichons.</p>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">append</span><span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">find_all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">is_empty</span><span class="p">(</span><span class="nx">snippets</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">snippet_one</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 1"</span><span class="p">,</span><span class="s2">"//FOO"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">snippet_two</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 2"</span><span class="p">,</span><span class="s2">"//Hello World"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">snippet_three</span> <span class="o">=</span> <span class="nx">make_snippet</span><span class="p">(</span><span class="s2">"essai 3"</span><span class="p">,</span><span class="s2">"//Me again !"</span><span class="p">,</span><span class="s2">"gregmak"</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_one</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_two</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet_three</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">iter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">snippet</span><span class="p">);</span>
        <span class="p">},</span> <span class="nx">snippets</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<h4>La vue.</h4>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">View</span> <span class="p">{</span>

    <span class="kd">function</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">display_snippet</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="nx">verb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">content</span> <span class="o">=</span>
        <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span> <span class="nx">by</span> <span class="p">{</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/h2&gt;&lt;br&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">Xhtml</span><span class="p">.</span><span class="nx">of_string_unsafe</span><span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">code</span><span class="p">)}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/li&gt;;</span>
    <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">snippet</span><span class="o">-</span><span class="nx">list</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">content</span><span class="p">},</span> <span class="o">~</span><span class="nx">verb</span><span class="p">}])</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">add_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
    <span class="nx">code</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="nx">Markdown</span><span class="p">.</span><span class="nx">xhtml_of_string</span><span class="p">({</span><span class="nx">detect_text_links</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="nx">_</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="nx">Xhtml</span><span class="p">.</span><span class="nx">to_string</span><span class="p">(</span><span class="nx">_</span><span class="p">);</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">||</span> <span class="nx">user</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Erreur"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">All</span> <span class="nx">fields</span> <span class="nx">are</span> <span class="nx">mandatory</span><span class="p">.</span> <span class="nx">Please</span> <span class="nx">fill</span> <span class="nx">them</span> <span class="nx">all</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">make_snippet</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="nx">Model</span><span class="p">.</span><span class="nx">save_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">title</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">code</span><span class="p">);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">user</span><span class="p">);</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">append</span><span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">show_all</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">find_all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">iteri</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">set</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">append</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="p">},</span> <span class="nx">snippets</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">show_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nx">Int</span><span class="p">.</span><span class="nx">of_string</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">set</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nx">Int</span><span class="p">.</span><span class="nx">of_string</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">delete_snippet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">ok</span><span class="p">}</span> <span class="o">:</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"OK"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">has</span> <span class="nx">been</span> <span class="nx">removed</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">);</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">ko</span><span class="p">}</span> <span class="o">:</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">simple_main_page</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">title_bar</span> <span class="o">=</span>
        <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"navbar navbar-fixed-top"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"navbar-inner"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"brand"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span>
        <span class="o">&lt;&gt;</span><span class="nx">OPA</span><span class="o">&lt;</span><span class="err">/&gt;</span>
        <span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/&gt;;</span>
    <span class="nx">form</span> <span class="o">=</span>
        <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet-form"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"margin-top:50px;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Go</span> <span class="p">...</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
        <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">method</span><span class="o">=</span><span class="s2">"post"</span> <span class="nx">action</span><span class="o">=</span><span class="s2">"javascript:void(0);"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"well"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Title</span> <span class="o">:</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"title"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"span3"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"title"</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Code</span> <span class="nx">Snippet</span> <span class="o">:</span> <span class="p">(</span><span class="kd">with</span> <span class="nx">markdown</span><span class="p">)</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"code"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"code"</span> <span class="nx">rows</span><span class="o">=</span><span class="s2">"5"</span><span class="o">&gt;&lt;</span><span class="err">/textarea&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">User</span> <span class="o">:</span> <span class="o">&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"user"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"user"</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"btn"</span> <span class="nx">onclick</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">add_snippet</span><span class="p">()}}</span><span class="o">&gt;</span><span class="nx">Add</span> <span class="nx">a</span> <span class="nx">Snippet</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
        <span class="o">&lt;</span><span class="err">/form&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/&gt;;</span>
    <span class="nx">boutons</span> <span class="o">=</span>
        <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span>  <span class="kr">class</span><span class="o">=</span><span class="s2">"btn"</span> <span class="nx">onclick</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">show_all</span><span class="p">()}}</span><span class="o">&gt;</span><span class="nx">Show</span> <span class="nx">all</span> <span class="nx">snippets</span><span class="o">&lt;</span><span class="err">/button&gt;&lt;/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span>  <span class="kr">class</span><span class="o">=</span><span class="s2">"btn"</span> <span class="nx">onclick</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">show_snippet</span><span class="p">()}}</span><span class="o">&gt;</span><span class="nx">Show</span> <span class="nx">snippet</span> <span class="nx">of</span> <span class="nx">id</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet_id_show"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"snippet-id"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"id"</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"submit"</span>  <span class="kr">class</span><span class="o">=</span><span class="s2">"btn"</span> <span class="nx">onclick</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">delete_snippet</span><span class="p">()}}</span><span class="o">&gt;</span><span class="nx">Delete</span> <span class="nx">snippet</span> <span class="nx">of</span> <span class="nx">id</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
        <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet_id_delete"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"snippet-id"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">"id"</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/&gt;;</span>
    <span class="nx">content</span> <span class="o">=</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">onready</span><span class="o">=</span><span class="p">{</span><span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span><span class="nx">initialize</span><span class="p">()}}</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">title_bar</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">form</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">boutons</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"snippet-list"</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"list-style: none;"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">data</span><span class="o">-</span><span class="nx">template</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">/li&gt;</span>
        <span class="o">&lt;</span><span class="err">/ul&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"notifications"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;;</span>
    <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"StyKKeKode in OPA"</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>

<p>La vue ne change pas énormément comparé à la version précédente sur la manipulation du DOM en <em>Opa</em>.
Elle comporte quelques fonctions suplémentaires que vous allons détailler maintenant.</p>

<h5>Affichage de tous les <em>snippets</em>.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">show_all</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">find_all</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">snippets</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">List</span><span class="p">.</span><span class="nx">iteri</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">snippet</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">set</span><span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">append</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="p">},</span> <span class="nx">snippets</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<p>Nous récupérons la liste de tous les <em>snippets</em> contenus dans la base par un appel à la fonction <em>find_all()</em> et pour chaque <em>snippet</em> contenu dans la liste nous appelons la fonction d'affichage <em>display_snippet()</em>.
Pour le 1er <em>snippet</em> à afficher nous passons la valeur {set} à la fonction <em>display_snippet()</em> pour lui indiquer que cet affichage doit écraser l'affichage précédent.
Par la suite nous utilisont la valeur {append} pour indiquer que les affichages suivants viendront s'ajouter au premier.</p>

<h5>Affichage d'un <em>snippet</em>.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">show_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nx">Int</span><span class="p">.</span><span class="nx">of_string</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="nx">snippet</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">find_by_id</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">snippet</span><span class="p">.</span><span class="nx">title</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">set</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<p>Pour afficher un <em>snippet</em> particulier, nous avons besoin de lire son identifiant renseigné par l'utilisateur dans le champ <em>snippet_id_show</em> (veuillez vous reporter au tutoriel sur la manipulation du DOM en <em>Opa</em> pour plus de détails sur ce sujet).
Une fois cet identifiant récupéré, nous appelons la fonction <em>find_by_id()</em> du modèle et nous appliquons un traitement particulier en fonction de la valeur retournée.</p>

<p>Nous avons précisé précédamment qu'une lecture sur un chemin de la base de données retournait toujours un résultat. Si aucune donnée ne se trouve sur un chemin donné, la valeur par défaut associée à ce chemin est retournée.
Nous devons donc regarder le conteunu de la valeur retournée pour nous assurer que ce n'est pas la valeur par défaut, mais bien un <em>snippet</em> trouvé sur le chemin donné.
Nous faisons le test ici uniquement sur le titre du <em>snippet</em> retourné pour nous assurer qu'il n'est pas vide, ce qui serait le cas pour la valeur par défaut.
Si le titre du <em>snippet</em> n'est pas vide, nous appelons la fonction d'affichage <em>display_snippet()</em> avec en paramètres le <em>snippet</em> retourné et la valeur {set} pour écraser l'affichage précédent :</p>

<div class="highlight"><pre>        <span class="nx">display_snippet</span><span class="p">(</span><span class="nx">snippet</span><span class="p">,</span> <span class="p">{</span><span class="nx">set</span><span class="p">});</span>
</pre></div>

<p>Si le titre du <em>snippet</em> est vide, nous affichons un message d'erreur pour indiquer à l'utilisateur que le <em>snippet</em> recherché n'a pas été trouvé.</p>

<div class="highlight"><pre>        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
</pre></div>

<p>Dans tous les cas, nous nettoyns le formulaire de la valeur lue dans le champ <em>snippet_id_show</em> :</p>

<div class="highlight"><pre>        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_show</span><span class="p">);</span>
</pre></div>

<h5>Suppression d'un <em>snippet</em>.</h5>

<div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">delete_snippet</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">Dom</span><span class="p">.</span><span class="nx">get_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nx">Int</span><span class="p">.</span><span class="nx">of_string</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span>
    <span class="nx">Model</span><span class="p">.</span><span class="nx">delete_snippet</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">match</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">ok</span><span class="p">}</span> <span class="o">:</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"OK"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">has</span> <span class="nx">been</span> <span class="nx">removed</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">);</span>
        <span class="k">case</span> <span class="p">{</span><span class="nx">ko</span><span class="p">}</span> <span class="o">:</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span><span class="nx">alert</span> <span class="o">:</span> <span class="p">{</span><span class="nx">title</span> <span class="o">:</span> <span class="s2">"Error"</span><span class="p">,</span> <span class="nx">description</span> <span class="o">:</span> <span class="o">&lt;&gt;</span> <span class="nx">Snippet</span> <span class="nx">of</span> <span class="nx">id</span> <span class="p">{</span><span class="nx">id</span><span class="p">}</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">exist</span><span class="p">.</span> <span class="o">&lt;</span><span class="err">/&gt;}, closable : true};</span>
        <span class="nx">alert</span> <span class="o">=</span> <span class="nx">WBootstrap</span><span class="p">.</span><span class="nx">Alert</span><span class="p">.</span><span class="nx">make</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">{</span><span class="nx">success</span><span class="p">});</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">transform</span><span class="p">([{</span><span class="nx">jq</span> <span class="o">:</span> <span class="err">#</span><span class="nx">notifications</span><span class="p">,</span> <span class="nx">subject</span> <span class="o">:</span> <span class="p">{</span><span class="nx">content</span> <span class="o">:</span> <span class="nx">alert</span><span class="p">},</span> <span class="nx">verb</span> <span class="o">:</span> <span class="p">{</span><span class="nx">set</span><span class="p">}}]);</span>
        <span class="nx">Dom</span><span class="p">.</span><span class="nx">clear_value</span><span class="p">(</span><span class="err">#</span><span class="nx">snippet_id_delete</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">}</span>
</pre></div>

<h4>Le controlleur.</h4>

<div class="highlight"><pre><span class="nx">module</span> <span class="nx">Controller</span> <span class="p">{</span>

    <span class="nx">dispatcher</span> <span class="o">=</span> <span class="nx">parser</span> <span class="p">{</span>
            <span class="o">|</span> <span class="s2">"/"</span> <span class="o">-&gt;</span> <span class="nx">View</span><span class="p">.</span><span class="nx">simple_main_page</span><span class="p">()</span>
            <span class="o">|</span> <span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">Resource</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span> <span class="o">&lt;&gt;&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="s2">"404 NOT FOUND!"</span><span class="o">&lt;</span><span class="sr">/h2&gt;&lt;/</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="nx">resources</span> <span class="o">=</span> <span class="err">@</span><span class="nx">static_resource_directory</span><span class="p">(</span><span class="s2">"resources"</span><span class="p">)</span>

<span class="nx">Server</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">Server</span><span class="p">.</span><span class="nx">http</span><span class="p">,</span> <span class="p">[</span>
  <span class="p">{</span> <span class="nx">register</span><span class="o">:</span>
    <span class="p">[</span> <span class="p">{</span> <span class="nx">doctype</span><span class="o">:</span> <span class="p">{</span> <span class="nx">html5</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">js</span><span class="o">:</span> <span class="p">[</span> <span class="p">]</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">css</span><span class="o">:</span> <span class="p">[</span> <span class="s2">"/resources/css/style.css"</span><span class="p">]</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="o">~</span><span class="nx">resources</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">custom</span><span class="o">:</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">dispatcher</span> <span class="p">}</span>
<span class="p">])</span>

</pre></div>

<p>Le code du controlleur ressemble fortement à celui de la précédente version. Nous lui ajoutons juste le chargement du fichier .css dans lequel nous avons défini le style pour quelques éléments de notre page.</p>

<h4>Testons cette application.</h4>

<p>Une fois l'application compliée et lancée, ouvrez votre navigateur à l'adresse <code>localhost:8080</code> qui est l'adresse par défaut.
Vous voyez que la page affiche déjà les 3 <em>snippets</em> que nous avons crées au démarrage du serveur.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_1.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Nous créeons un nouveau snippet.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_2.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>La page affiche bien maintenant les 4 contenus dans la base.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_3.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Testons maintent l'affichage d'un <em>snippet</em> en particulier.
Entrez la valeur "3" dans le champ de saisie à droite du bouton 'Show snippet of id', puis validez en cliquant sur le bouton ou en appuyant sur la toûche 'Entrée'.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_4.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Nous voyons que seul le <em>snippet</em> d'identifiant "3" est affiché.</p>

<p>Testons maintenant la suppression d'un <em>snippet</em>.
Entrez la valeur "4" dans le champ de saisie à droite du bouton 'Delete snippet of id', puis validez en cliquant sur le bouton ou en appuyant sur la toûche 'Entrée'.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_5.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Vérifions que la suppression a bien été éfféctuée.
Demandons l'affichage du <em>snippet</em> d'identifiant "4", soit celui que nous venons de supprimer.
Entrez la valeur "4" dans le champ de saisie à droite du bouton 'Show snippet of id', puis validez en cliquant sur le bouton ou en appuyant sur la toûche 'Entrée'.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_6.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Nous voyons que le système nous préviens que le <em>snippet</em> recherché n'existe pas.</p>

<p>Demandons maintenant l'affichage de tous les <em>snippets</em> contenus dans la base.
Cliquez sur le bouton 'Show all snippets'.</p>

<p><img src="https://github.com/gregmak/gregmak.github.com/blob/master/images/v3/snippets_v3_7.png?raw=true" alt="snippets_v2_error_server_2.png"></p>

<p>Nous voyons bien que seulement 3 <em>snippets</em> sont affichés. Le <em>snippet</em> d'identifiant "4" a bien été supprimé de la base de données.</p>

<h4>Conclusion.</h4>

<p>Nous venons de voir comment gérer la persistance via l'utilisation d'une base de données <strong>NoSQL</strong> (en l'occurrence <strong>MongoDB</strong>).</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
